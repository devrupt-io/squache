# Squache Squid Configuration
# SSL Bumping Caching Proxy for Web Scraping

# Network settings
http_port 3128 ssl-bump \
  cert=/etc/squid/ssl/squid-ca.crt \
  key=/etc/squid/ssl/squid-ca.key \
  generate-host-certificates=on \
  dynamic_cert_mem_cache_size=4MB

# SSL settings
sslcrtd_program /usr/lib/squid/security_file_certgen -s /var/lib/squid/ssl_db -M 4MB
sslcrtd_children 8 startup=1 idle=1

# SSL bump rules
acl step1 at_step SslBump1
ssl_bump peek step1
ssl_bump bump all

# TLS settings
tls_outgoing_options options=NO_SSLv3,NO_TLSv1,NO_TLSv1_1
tls_outgoing_options cipher=HIGH:MEDIUM:!RC4:!aNULL:!eNULL:!LOW:!3DES:!MD5:!EXP:!PSK:!SRP:!DSS

# Cache settings
cache_mem 512 MB
maximum_object_size_in_memory 10 MB
cache_dir ufs /var/spool/squid 10000 16 256
maximum_object_size 1 GB
minimum_object_size 0 KB

# Cache replacement policy
cache_replacement_policy heap LFUDA
memory_replacement_policy heap GDSF

# Aggressive caching for static assets
refresh_pattern -i \.(gif|png|jpg|jpeg|ico|webp|svg|bmp|tiff)$ 10080 90% 43200 override-expire override-lastmod reload-into-ims ignore-reload ignore-no-store ignore-private
refresh_pattern -i \.(css|js|jsx|ts|tsx|mjs)$ 10080 90% 43200 override-expire override-lastmod reload-into-ims ignore-reload ignore-no-store ignore-private
refresh_pattern -i \.(woff|woff2|ttf|otf|eot)$ 10080 90% 43200 override-expire override-lastmod reload-into-ims ignore-reload ignore-no-store ignore-private
refresh_pattern -i \.(mp4|webm|avi|mov|mkv|flv|wmv|m4v)$ 10080 90% 43200 override-expire override-lastmod reload-into-ims ignore-reload ignore-no-store ignore-private
refresh_pattern -i \.(mp3|wav|ogg|flac|m4a|aac)$ 10080 90% 43200 override-expire override-lastmod reload-into-ims ignore-reload ignore-no-store ignore-private
refresh_pattern -i \.(pdf|doc|docx|xls|xlsx|ppt|pptx)$ 10080 90% 43200 override-expire override-lastmod reload-into-ims ignore-reload ignore-no-store ignore-private
refresh_pattern -i \.(zip|rar|7z|tar|gz|bz2)$ 10080 90% 43200 override-expire override-lastmod reload-into-ims ignore-reload ignore-no-store ignore-private
refresh_pattern . 0 20% 4320

# Allow local network
acl localnet src 10.0.0.0/8
acl localnet src 172.16.0.0/12
acl localnet src 192.168.0.0/16
acl localnet src fc00::/7
acl localnet src fe80::/10

# Safe ports
acl SSL_ports port 443
acl Safe_ports port 80
acl Safe_ports port 21
acl Safe_ports port 443
acl Safe_ports port 70
acl Safe_ports port 210
acl Safe_ports port 1025-65535
acl Safe_ports port 280
acl Safe_ports port 488
acl Safe_ports port 591
acl Safe_ports port 777

acl CONNECT method CONNECT

# Access rules
http_access deny !Safe_ports
http_access deny CONNECT !SSL_ports
http_access allow localnet
http_access allow localhost
http_access deny all

# Custom headers for upstream proxy selection
# X-Squache-Upstream: direct|vpn|residential
# X-Squache-Country: ISO country code
# X-Squache-City: city name
# X-Squache-Provider: provider name

# Request headers we want to log
request_header_access X-Squache-Upstream allow all
request_header_access X-Squache-Country allow all
request_header_access X-Squache-City allow all
request_header_access X-Squache-Provider allow all

# Strip our custom headers before forwarding
request_header_access X-Squache-Upstream deny all
request_header_access X-Squache-Country deny all
request_header_access X-Squache-City deny all
request_header_access X-Squache-Provider deny all

# Logging
logformat squache %ts.%03tu %6tr %>a %Ss/%03>Hs %<st %rm %ru %[un %Sh/%<a %mt "%{X-Squache-Upstream}>h" "%{X-Squache-Country}>h"
access_log stdio:/var/log/squid/access.log squache
cache_log /var/log/squid/cache.log
cache_store_log /var/log/squid/store.log

# Log rotation
logfile_rotate 7

# Coredump directory
coredump_dir /var/spool/squid

# Visible hostname
visible_hostname squache-proxy

# Admin email
cache_mgr admin@squache.local

# Shutdown timeout
shutdown_lifetime 3 seconds

# Error pages
error_directory /usr/share/squid/errors/en

# Include upstream proxy configuration (managed by backend)
include /etc/squid/conf.d/upstreams.conf
